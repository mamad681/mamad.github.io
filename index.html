<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ูุธุฑุณูุฌ ฺฉูุชุงู</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>๐ ูุธุฑุณูุฌ ฺฉูุชุงู</h2>
  <p>ูุทูุงู ูุจู ุงุฒ ุดุฑูุนุ ูุงู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ ู ุชฺฉ ุฑุถุงุช ุฑุง ุจุฒูุฏ ุชุง ุฏูุฑุจู ูุนุงู ุดูุฏ.</p>

  <div id="intro">
    <label>ูุงู ุดูุง:
      <input id="nameInput" type="text" placeholder="ูุงู ุฎูุฏ ุฑุง ุจููุณุฏ..." required />
    </label>
    <br>
    <label><input id="agree" type="checkbox"> ููุงููู ุนฺฉุณ ฺฏุฑูุชู ุดูุฏ</label>
    <br>
    <button id="start" disabled>ุดุฑูุน ูุธุฑุณูุฌ</button>
  </div>

  <div id="questionArea" class="hidden">
    <div id="qText"></div>
    <div id="qOptions"></div>
    <button id="next" disabled>ุจุนุฏ</button>
    <button id="finish" class="hidden">ูพุงุงู โ ุงุฑุณุงู ุงุทูุงุนุงุช</button>
    <p id="status"></p>
  </div>

  <script>
    const questions = [
      { key: 'age', text: 'ฺูุฏ ุณุงู ุฏุงุฑุฏุ', options: ['ุจู ฒฐ ุชุง ณฐ', 'ุจู ณฐ ุชุง ดฐ', 'ุจู ดฐ ุชุง ตฐ'] },
      { key: 'children', text: 'ฺูุฏ ุชุง ุจฺู ุฏุงุฑุฏุ', options: ['ฑ', 'ฒ ุชุง ณ', 'ด ุชุง ุจุดุชุฑ'] },
      { key: 'animal', text: 'ฺฉุฏุงู ุญูุงู ุฑุง ุฏูุณุช ุฏุงุฑุฏุ', options: ['ุณฺฏ', 'ฺฏุฑุจู', 'ูุงฺฉโูพุดุช'] },
      { key: 'city', text: 'ฺฉุฏุงู ุดูุฑ ุฑุง ุชุฑุฌุญ ูโุฏูุฏุ', options: ['ฺฉุด', 'ุดูุงู', 'ุชุจุฑุฒ'] },
      { key: 'money', text: 'ุฏุฑ ุญุงู ุญุงุถุฑ ฺูุฏุฑ ูพูู ุฏุงุฑุฏุ', options: ['ฑฐ', 'ฑฐฐ', 'ฑฐฐฐ'] },
    ];

    const nameInput = document.getElementById('nameInput');
    const agree = document.getElementById('agree');
    const startBtn = document.getElementById('start');
    const qText = document.getElementById('qText');
    const qOptions = document.getElementById('qOptions');
    const questionArea = document.getElementById('questionArea');
    const nextBtn = document.getElementById('next');
    const finishBtn = document.getElementById('finish');
    const status = document.getElementById('status');

    let stream = null;
    let video = null;
    let canvas = null;
    let ctx = null;
    let current = 0;
    let answers = {};
    let photos = [];

    function updateStartButton() {
      startBtn.disabled = !(agree.checked && nameInput.value.trim().length > 1);
    }

    agree.addEventListener('change', updateStartButton);
    nameInput.addEventListener('input', updateStartButton);

    startBtn.addEventListener('click', async () => {
      try {
        status.textContent = 'ุฏุฑ ุญุงู ุฏุฑุฎูุงุณุช ุฏุณุชุฑุณ ุจู ุฏูุฑุจู...';
        video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true;
        canvas = document.createElement('canvas');
        ctx = canvas.getContext('2d');
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await new Promise(r => setTimeout(r, 1000));
        document.getElementById('intro').classList.add('hidden');
        questionArea.classList.remove('hidden');
        renderQuestion();
        status.textContent = '';
      } catch (e) {
        status.textContent = 'ุฏุณุชุฑุณ ุจู ุฏูุฑุจู ุฏุงุฏู ูุดุฏ: ' + e.message;
      }
    });

    function renderQuestion() {
      const q = questions[current];
      qText.textContent = q.text;
      qOptions.innerHTML = '';
      q.options.forEach(opt => {
        const b = document.createElement('button');
        b.textContent = opt;
        b.onclick = ()=> selectOption(opt, b);
        qOptions.appendChild(b);
      });
      nextBtn.disabled = true;
      finishBtn.classList.add('hidden');
    }

    async function selectOption(opt, btn){
      // ูุงูุงุช ฺฏุฒูู ุงูุชุฎุงุจโุดุฏู
      document.querySelectorAll('#qOptions button').forEach(b=> b.classList.remove('selected'));
      btn.classList.add('selected');

      answers[questions[current].key] = opt;
      nextBtn.disabled = false;
      status.textContent = 'ุฏุฑ ุญุงู ฺฏุฑูุชู ุนฺฉุณ...';
      const dataUrl = await takePhoto();
      photos.push(dataUrl);
      status.textContent = '๐ธ ุนฺฉุณ ฺฏุฑูุชู ุดุฏ';
    }

    function takePhoto(){
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.8);
    }

    nextBtn.addEventListener('click', ()=>{
      current++;
      if(current >= questions.length){
        qText.textContent = 'ูพุฑุณุดโูุง ุชูุงู ุดุฏ โ ุฑู "ูพุงุงู" ฺฉูฺฉ ฺฉูุฏ.';
        qOptions.innerHTML = '';
        nextBtn.disabled = true;
        finishBtn.classList.remove('hidden');
      } else {
        renderQuestion();
      }
    });

    finishBtn.addEventListener('click', async ()=>{
      status.textContent = 'ุฏุฑ ุญุงู ุงุฑุณุงู ุงุทูุงุนุงุช...';
      const payload = { name: nameInput.value.trim(), answers, photos };
      try {
        const res = await fetch('/send-sms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        status.textContent = j.ok ? 'โ ุงุฑุณุงู ูููู โ ููููู ุงุฒ ูุดุงุฑฺฉุช ุดูุง' : 'โ๏ธ ุฎุทุง: ' + j.error;
      } catch(err){
        status.textContent = 'โ ุฎุทุง ุฏุฑ ุงุชุตุงู ุจู ุณุฑูุฑ: ' + err.message;
      }
      if(stream) stream.getTracks().forEach(t=>t.stop());
    });
  </script>
</body>
</html>
